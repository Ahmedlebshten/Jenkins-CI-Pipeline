pipeline {
  agent any

  parameters {
    string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag to scan')
  }

  environment {
    DOCKERHUB_REPO = "ahmedlebshten/url-shortener"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Gitleaks Scan') {
      steps {
        sh '''
          echo "ğŸ” Cloning and Scanning CI Repo with Gitleaks..."

          rm -rf ci
          git clone https://github.com/Ahmedlebshten/Jenkins-CI-Pipeline.git ci

          # Ù„Ùˆ Ù…Ø´ Ù…Ø­ØªØ§Ø¬ history Ø§Ø³ØªØ®Ø¯Ù… --no-git Ø¹Ø´Ø§Ù† ØªÙ…Ù†Ø¹ error Ø¨ØªØ§Ø¹ git
          docker run --rm -v $PWD/ci:/repo zricethezav/gitleaks:latest detect --source=/repo --no-git || true

          echo "âœ… Gitleaks Scan Finished!"
        '''
      }
    }

    stage('SonarQube Scan') {
      environment {
        SONAR_HOST_URL = "http://54.147.28.81:9100"
        SONAR_TOKEN    = credentials('sonar-token')
      }
      steps {
        withSonarQubeEnv('SonarQube') {            // Ø§Ø³Ù… Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ù† Manage Jenkins â†’ SonarQube servers
          script {
            def scannerHome = tool 'sonar-scanner' // Ø§Ø³Ù… Ø§Ù„Ù€ Scanner Ù…Ù† Global Tool Configuration
            sh """
              echo "ğŸ” Running SonarQube Scan..."

              rm -rf ci
              git clone https://github.com/Ahmedlebshten/Jenkins-CI-Pipeline.git ci
              cd ci

              ${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=ci \
                -Dsonar.sources=. \
                -Dsonar.host.url=${SONAR_HOST_URL} \
                -Dsonar.login=${SONAR_TOKEN} || true

              echo "âœ… SonarQube Scan Finished!"
            """
          }
        }
      }
    }

    stage('Trivy Image Scan') {
      steps {
        sh """
          echo "ğŸ” Scanning Docker Image using Trivy..."

          # Ø§Ø³ØªØ®Ø¯Ù… Docker daemon Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§Ù„ØµÙˆØ±Ø© Ù„Ø³Ù‡ Ù…Ø¨Ù†ÙŠØ© ÙÙŠ CI job)
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image ${DOCKERHUB_REPO}:${params.IMAGE_TAG}

          echo "âœ… Trivy Image Scan Completed!"
        """
      }
    }
  }

  post {
    success { echo "Security scans passed for image tag: ${params.IMAGE_TAG}" }
    failure { echo "Security scans failed!" }
  }
}
